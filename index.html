<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cara HQ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config={darkMode:'class',theme:{extend:{}}}</script>
  <style>
    body { background: #030712; color: #e5e7eb; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    .tab-active { background: rgba(59,130,246,0.15); color: #60a5fa; }
    .card { background: #111827; border: 1px solid #1f2937; border-radius: 0.75rem; padding: 1rem; }
    .stat-box { background: rgba(31,41,55,0.5); border-radius: 0.5rem; padding: 0.75rem; text-align: center; }
    .kanban-col { min-height: 120px; }
    .task-card { background: #1f2937; border: 1px solid rgba(55,65,81,0.5); border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 0.5rem; cursor: grab; }
    .task-card:active { cursor: grabbing; opacity: 0.8; }
    .task-card.drag-over { border-color: #3b82f6; }
    .drop-zone.drag-over { background: rgba(59,130,246,0.05); border-color: rgba(59,130,246,0.3); }
    .pulse-green { animation: pulse-g 2s infinite; }
    @keyframes pulse-g { 0%,100% { opacity:1 } 50% { opacity:0.5 } }
    .badge { font-size: 0.625rem; padding: 0.125rem 0.375rem; border-radius: 0.25rem; border: 1px solid; }
    .scrollbar-thin::-webkit-scrollbar { width: 4px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #374151; border-radius: 2px; }
    #login-screen { backdrop-filter: blur(8px); }
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(8px) } to { opacity:1; transform:translateY(0) } }
    .timeline-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; margin-top: 4px; }
    .timeline-line { width: 1px; min-height: 20px; background: #374151; }
    .token-bar { height: 4px; border-radius: 2px; transition: width 0.3s; }
    .severity-critical { color: #f87171; }
    .severity-error { color: #fb923c; }
    .severity-warning { color: #fbbf24; }
    .severity-info { color: #60a5fa; }
  </style>
</head>
<body class="min-h-screen">

<!-- Login Screen -->
<div id="login-screen" class="fixed inset-0 z-[200] bg-gray-950/95 flex items-center justify-center">
  <div class="card w-full max-w-sm mx-4 text-center">
    <div class="text-4xl mb-3">ğŸ¾</div>
    <h1 class="text-xl font-bold mb-1">Cara HQ</h1>
    <p class="text-xs text-gray-500 mb-6">Mission Control & Workboard</p>
    <input id="login-pw" type="password" placeholder="Password"
      class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:border-blue-500 mb-3"
      onkeydown="if(event.key==='Enter')doLogin()">
    <button onclick="doLogin()" class="w-full bg-blue-600 hover:bg-blue-500 rounded-lg py-2.5 text-sm font-medium transition-colors">Enter</button>
    <p id="login-error" class="text-red-400 text-xs mt-2 hidden">Wrong password</p>
  </div>
</div>

<!-- Main App -->
<div id="app" class="hidden">
  <!-- Header -->
  <header class="border-b border-gray-800 bg-gray-900/50 backdrop-blur-sm sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="text-2xl">ğŸ¾</span>
        <div>
          <h1 class="text-lg font-bold leading-tight">Cara HQ</h1>
          <p class="text-[10px] text-gray-500 leading-tight">Mission Control & Workboard</p>
        </div>
      </div>
      <nav id="nav-tabs" class="flex gap-1 overflow-x-auto">
        <button onclick="switchTab('overview')" data-tab="overview" class="tab-btn px-3 py-1.5 rounded-lg text-sm transition-colors whitespace-nowrap">ğŸ“Š Overview</button>
        <button onclick="switchTab('kanban')" data-tab="kanban" class="tab-btn px-3 py-1.5 rounded-lg text-sm transition-colors whitespace-nowrap">ğŸ“‹ Kanban</button>
        <button onclick="switchTab('sessions')" data-tab="sessions" class="tab-btn px-3 py-1.5 rounded-lg text-sm transition-colors whitespace-nowrap">ğŸ”Œ Sessions</button>
        <button onclick="switchTab('calendar')" data-tab="calendar" class="tab-btn px-3 py-1.5 rounded-lg text-sm transition-colors whitespace-nowrap">ğŸ“… Calendar</button>
        <button onclick="switchTab('activity')" data-tab="activity" class="tab-btn px-3 py-1.5 rounded-lg text-sm transition-colors whitespace-nowrap">âš¡ Activity</button>
        <button onclick="switchTab('search')" data-tab="search" class="tab-btn px-3 py-1.5 rounded-lg text-sm transition-colors whitespace-nowrap">ğŸ” Search</button>
      </nav>
      <div class="flex items-center gap-3">
        <span id="live-clock" class="font-mono text-sm text-gray-400"></span>
        <span id="sync-indicator" class="text-xs text-gray-600">â³</span>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto w-full p-4">
    <!-- Overview Tab -->
    <div id="tab-overview" class="tab-content">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="lg:col-span-2 space-y-4">
          <!-- Gateway Health -->
          <div class="card" id="gateway-card">
            <h2 class="font-semibold text-sm mb-3">ğŸŒ Gateway Health</h2>
            <div id="gateway-content" class="text-sm text-gray-400">Loading...</div>
          </div>
          <!-- Sessions Summary -->
          <div class="card">
            <h2 class="font-semibold text-sm mb-3">ğŸ”Œ Active Sessions</h2>
            <div id="sessions-summary" class="text-sm text-gray-400">Loading...</div>
          </div>
          <!-- Agent Errors -->
          <div class="card">
            <div class="flex items-center justify-between mb-3">
              <h2 class="font-semibold text-sm">ğŸš¨ Agent Health & Errors</h2>
              <span id="error-summary-badge" class="text-xs text-green-400">âœ“ All clear</span>
            </div>
            <!-- Service Health -->
            <div class="mb-3">
              <p class="text-xs text-gray-500 mb-2 uppercase tracking-wider">Service Health</p>
              <div id="service-health" class="space-y-1.5"></div>
            </div>
            <!-- Error Log -->
            <div>
              <p class="text-xs text-gray-500 mb-2 uppercase tracking-wider">Recent Errors</p>
              <div id="error-log" class="space-y-1.5 max-h-60 overflow-y-auto scrollbar-thin"></div>
            </div>
          </div>
        </div>
        <div class="space-y-4">
          <!-- System Stats -->
          <div class="card">
            <h2 class="font-semibold text-sm mb-3">ğŸ’» System Stats</h2>
            <div id="system-stats" class="space-y-3">Loading...</div>
          </div>
          <!-- Fleet Status -->
          <div class="card">
            <h2 class="font-semibold text-sm mb-3">ğŸ¤– Fleet</h2>
            <div id="fleet-status" class="space-y-2">Loading...</div>
          </div>
          <!-- Quick Stats -->
          <div class="card">
            <h2 class="font-semibold text-sm mb-3">ğŸ“‹ Quick Stats</h2>
            <div id="quick-stats" class="grid grid-cols-2 gap-3"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Kanban Tab -->
    <div id="tab-kanban" class="tab-content hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="font-semibold text-lg">ğŸ“‹ Workboard</h2>
        <div id="kanban-filters" class="flex gap-2 flex-wrap"></div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="kanban-board"></div>
    </div>

    <!-- Sessions Tab -->
    <div id="tab-sessions" class="tab-content hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="font-semibold text-lg">ğŸ”Œ Live Sessions <span id="session-count" class="text-gray-500 text-sm"></span></h2>
        <div class="flex gap-2">
          <button onclick="setSessionFilter('all')" id="sf-all" class="px-3 py-1 rounded-lg text-xs border bg-blue-600/20 text-blue-400 border-blue-500/30">All</button>
          <button onclick="setSessionFilter('active')" id="sf-active" class="px-3 py-1 rounded-lg text-xs border bg-gray-800 text-gray-400 border-gray-700">Active</button>
          <button onclick="setSessionFilter('idle')" id="sf-idle" class="px-3 py-1 rounded-lg text-xs border bg-gray-800 text-gray-400 border-gray-700">Idle</button>
          <button onclick="setSessionFilter('completed')" id="sf-completed" class="px-3 py-1 rounded-lg text-xs border bg-gray-800 text-gray-400 border-gray-700">Completed</button>
        </div>
      </div>
      <div id="sessions-full" class="space-y-3">Loading...</div>
    </div>

    <!-- Calendar Tab -->
    <div id="tab-calendar" class="tab-content hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="font-semibold text-lg">ğŸ“… Daily Timeline <span id="calendar-date" class="text-gray-500 text-sm ml-2"></span></h2>
      </div>
      <div id="calendar-timeline" class="relative">Loading...</div>
    </div>

    <!-- Activity Tab -->
    <div id="tab-activity" class="tab-content hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="font-semibold text-lg">âš¡ Activity Feed <span id="activity-count" class="text-gray-500 text-sm"></span></h2>
        <div class="flex gap-2">
          <button onclick="setActivitySort('time')" id="as-time" class="text-xs px-2 py-1 rounded bg-blue-600/20 text-blue-400">Time â†“</button>
          <button onclick="setActivitySort('category')" id="as-category" class="text-xs px-2 py-1 rounded text-gray-500 hover:text-gray-300">Category</button>
        </div>
      </div>
      <div id="activity-filters" class="flex gap-2 mb-4 flex-wrap"></div>
      <div id="activity-feed" class="space-y-2 max-h-[70vh] overflow-y-auto scrollbar-thin">Loading...</div>
    </div>

    <!-- Search Tab -->
    <div id="tab-search" class="tab-content hidden">
      <h2 class="font-semibold text-lg mb-4">ğŸ” Global Search</h2>
      <div class="flex gap-3 mb-4">
        <input id="search-input" placeholder="Search sessions, tasks, activity..."
          class="flex-1 bg-gray-900 border border-gray-800 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-blue-500"
          onkeydown="if(event.key==='Enter')doSearch()">
        <button onclick="doSearch()" class="bg-blue-600 hover:bg-blue-500 px-6 rounded-xl text-sm font-medium transition-colors">Search</button>
      </div>
      <div id="search-type-filters" class="flex gap-2 mb-4">
        <button onclick="setSearchFilter('all')" id="stf-all" class="px-3 py-1 rounded-lg text-xs border bg-blue-600/20 text-blue-400 border-blue-500/30">All</button>
        <button onclick="setSearchFilter('session')" id="stf-session" class="px-3 py-1 rounded-lg text-xs border bg-gray-800 text-gray-400 border-gray-700">ğŸ”Œ Sessions</button>
        <button onclick="setSearchFilter('task')" id="stf-task" class="px-3 py-1 rounded-lg text-xs border bg-gray-800 text-gray-400 border-gray-700">ğŸ“‹ Tasks</button>
        <button onclick="setSearchFilter('activity')" id="stf-activity" class="px-3 py-1 rounded-lg text-xs border bg-gray-800 text-gray-400 border-gray-700">âš¡ Activity</button>
      </div>
      <div id="search-results"></div>
    </div>
  </main>
</div>

<script>
// â”€â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SECURITY: do NOT embed database credentials in a public static site.
// Dashboard should load a sanitized snapshot JSON (e.g. ./data/live.json) generated by sync.js.
const NEON_CONFIG = { host: '', connectionString: '' };
const PASSWORD_HASH = 'f61f5c5e22749aeba2bd920352dbd4c9f63e0ebaed6df623b09c836ffcbec2eb';
const REFRESH_INTERVAL = 30000;

// â”€â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sha256(text) {
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(text));
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
}
async function doLogin() {
  const pw = document.getElementById('login-pw').value;
  if (await sha256(pw) === PASSWORD_HASH) {
    sessionStorage.setItem('cara-auth', '1');
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');
    initDashboard();
  } else {
    document.getElementById('login-error').classList.remove('hidden');
    document.getElementById('login-pw').value = '';
    document.getElementById('login-pw').focus();
  }
}
if (sessionStorage.getItem('cara-auth') === '1') {
  document.getElementById('login-screen').classList.add('hidden');
  document.getElementById('app').classList.remove('hidden');
  setTimeout(initDashboard, 0);
}

// â”€â”€â”€ Data Source (sanitized JSON snapshot) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Expected shape matches cachedData fields: system,gateway,sessions,tasks,activity,fleet,calendar,errors,services
async function fetchSnapshot() {
  try {
    const res = await fetch('./data/live.json', { cache: 'no-store' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    return await res.json();
  } catch (e) {
    return null;
  }
}

// â”€â”€â”€ Clock â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateClock() {
  document.getElementById('live-clock').textContent =
    new Date().toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
}

// â”€â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let activeTab = 'overview';
function switchTab(tab) {
  activeTab = tab;
  document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
  document.getElementById('tab-' + tab)?.classList.remove('hidden');
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.toggle('tab-active', btn.dataset.tab === tab);
    if (btn.dataset.tab !== tab) btn.classList.add('text-gray-400', 'hover:text-gray-200', 'hover:bg-gray-800');
    else btn.classList.remove('text-gray-400', 'hover:text-gray-200', 'hover:bg-gray-800');
  });
  if (tab === 'search') document.getElementById('search-input')?.focus();
}

// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let cachedData = { system: null, gateway: null, sessions: [], tasks: [], activity: [], fleet: [], calendar: [], errors: [], services: [] };
let sessionFilter = 'all';
let activityFilter = 'all';
let activitySort = 'time';
let searchFilter = 'all';

// â”€â”€â”€ Data Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAllData() {
  const indicator = document.getElementById('sync-indicator');
  indicator.textContent = 'ğŸ”„';
  try {
    const snap = await fetchSnapshot();
    if (!snap) throw new Error('No snapshot');

    cachedData.system = snap.system || null;
    cachedData.gateway = snap.gateway || null;
    cachedData.sessions = snap.sessions || [];
    cachedData.tasks = snap.tasks || [];
    cachedData.activity = snap.activity || [];
    cachedData.fleet = snap.fleet || [];
    cachedData.calendar = snap.calendar || [];
    cachedData.errors = snap.errors || [];
    cachedData.services = snap.services || [];

    const hasData = cachedData.system || cachedData.gateway || cachedData.tasks.length || cachedData.fleet.length;
    if (!hasData) { renderDemoData(); return; }
    renderAll();
    indicator.textContent = 'âœ…';
    setTimeout(() => indicator.textContent = '', 2000);
  } catch (err) {
    console.error('Load error:', err);
    indicator.textContent = 'âŒ';
    renderDemoData();
  }
}

// â”€â”€â”€ Renderers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAll() {
  renderSystemStats(); renderGateway(); renderFleet(); renderQuickStats();
  renderSessionsSummary(); renderSessionsFull(); renderKanban();
  renderActivity(); renderCalendar(); renderErrors(); renderServices();
}

function renderSystemStats() {
  const el = document.getElementById('system-stats');
  const s = cachedData.system;
  if (!s) { el.innerHTML = '<p class="text-gray-500 text-sm">No data yet</p>'; return; }
  const memPct = s.mem_total_gb > 0 ? ((s.mem_used_gb / s.mem_total_gb) * 100).toFixed(0) : 0;
  const diskPct = s.disk_total_gb > 0 ? ((s.disk_used_gb / s.disk_total_gb) * 100).toFixed(0) : 0;
  el.innerHTML = `
    <div><div class="flex justify-between text-xs mb-1"><span class="text-gray-400">CPU</span><span>${s.cpu_usage||0}%</span></div>
      <div class="w-full bg-gray-800 rounded-full h-2"><div class="bg-blue-500 rounded-full h-2 transition-all" style="width:${Math.min(s.cpu_usage||0,100)}%"></div></div></div>
    <div><div class="flex justify-between text-xs mb-1"><span class="text-gray-400">Memory</span><span>${s.mem_used_gb?.toFixed(1)||0} / ${s.mem_total_gb?.toFixed(0)||0} GB (${memPct}%)</span></div>
      <div class="w-full bg-gray-800 rounded-full h-2"><div class="bg-purple-500 rounded-full h-2 transition-all" style="width:${memPct}%"></div></div></div>
    <div><div class="flex justify-between text-xs mb-1"><span class="text-gray-400">Disk</span><span>${s.disk_used_gb||0} / ${s.disk_total_gb||0} GB (${diskPct}%)</span></div>
      <div class="w-full bg-gray-800 rounded-full h-2"><div class="bg-green-500 rounded-full h-2 transition-all" style="width:${diskPct}%"></div></div></div>
    <div class="text-xs text-gray-500 mt-1">Load: ${s.load_avg||'â€”'} Â· Uptime: ${formatUptime(s.uptime_seconds)}</div>`;
}

function renderGateway() {
  const el = document.getElementById('gateway-content');
  const g = cachedData.gateway;
  if (!g) { el.innerHTML = '<p class="text-gray-500">No gateway data</p>'; return; }
  const isRunning = g.status === 'running';
  el.innerHTML = `
    <div class="flex items-center gap-3 mb-3">
      <div class="w-3 h-3 rounded-full ${isRunning ? 'bg-green-400 pulse-green' : 'bg-red-400'}"></div>
      <span class="font-medium ${isRunning ? 'text-green-400' : 'text-red-400'}">${g.status?.toUpperCase()||'UNKNOWN'}</span>
      ${g.version ? `<span class="text-xs text-gray-500">v${g.version}</span>` : ''}
      ${g.pid ? `<span class="text-xs text-gray-600">PID ${g.pid}</span>` : ''}
    </div>
    ${g.uptime ? `<div class="text-xs text-gray-500">Uptime: ${g.uptime}</div>` : ''}
    <div class="text-xs text-gray-600 mt-2">Last check: ${timeAgo(g.created_at)}</div>`;
}

function renderFleet() {
  const el = document.getElementById('fleet-status');
  const nodes = cachedData.fleet;
  if (!nodes.length) { el.innerHTML = '<p class="text-gray-500 text-sm">No fleet data</p>'; return; }
  el.innerHTML = nodes.map(n => `
    <div class="bg-gray-800/50 rounded-lg p-3 border border-gray-800">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2"><span>${n.node_name==='cara'?'ğŸ¾':'ğŸ¦Š'}</span>
          <div><p class="text-sm font-medium capitalize">${n.node_name}</p><p class="text-xs text-gray-500">${n.role||'agent'}</p></div></div>
        <div class="w-2.5 h-2.5 rounded-full ${n.status==='online'?'bg-green-400':'bg-red-400'}"></div>
      </div><div class="text-xs text-gray-600 mt-1">Updated ${timeAgo(n.updated_at)}</div>
    </div>`).join('');
}

function renderQuickStats() {
  const el = document.getElementById('quick-stats');
  const tasks = cachedData.tasks;
  const total = tasks.length, inProgress = tasks.filter(t=>t.col==='in-progress').length;
  const done = tasks.filter(t=>t.col==='done').length;
  const cost = tasks.reduce((s,t)=>s+(parseFloat(t.cost_estimate)||0),0);
  el.innerHTML = `
    <div class="stat-box"><div class="text-2xl font-bold text-blue-400">${total}</div><div class="text-xs text-gray-500">Total Tasks</div></div>
    <div class="stat-box"><div class="text-2xl font-bold text-yellow-400">${inProgress}</div><div class="text-xs text-gray-500">In Progress</div></div>
    <div class="stat-box"><div class="text-2xl font-bold text-green-400">${done}</div><div class="text-xs text-gray-500">Done</div></div>
    <div class="stat-box"><div class="text-2xl font-bold text-purple-400">$${cost.toFixed(0)}</div><div class="text-xs text-gray-500">Total Cost</div></div>`;
}

// â”€â”€â”€ Sessions (rich) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSessionsSummary() {
  const el = document.getElementById('sessions-summary');
  const sessions = cachedData.sessions;
  if (!sessions.length) { el.innerHTML = '<p class="text-gray-500">No active sessions</p>'; return; }
  el.innerHTML = sessions.slice(0,3).map(s => renderSessionCard(s, true)).join('');
}

function renderSessionsFull() {
  const el = document.getElementById('sessions-full');
  const sessions = cachedData.sessions;
  if (!sessions.length) { el.innerHTML = '<p class="text-gray-500">No session data available</p>'; return; }
  const filtered = sessionFilter === 'all' ? sessions : sessions.filter(s => s.status === sessionFilter);
  document.getElementById('session-count').textContent = `(${filtered.length})`;
  el.innerHTML = filtered.map(s => renderSessionCard(s, false)).join('');
}

function renderSessionCard(s, compact) {
  // Rich session with model/tokens/cost/channel/status
  if (s.model && s.model !== 'unknown') {
    const pct = s.token_pct || 0;
    const barColor = pct > 80 ? 'bg-red-400' : pct > 50 ? 'bg-yellow-400' : 'bg-blue-400';
    const statusColor = s.status === 'active' ? 'text-green-400' : s.status === 'idle' ? 'text-yellow-400' : 'text-gray-500';
    const statusDot = s.status === 'active' ? 'bg-green-400' : s.status === 'idle' ? 'bg-yellow-400' : 'bg-gray-500';
    const kindIcon = s.channel === 'telegram' ? 'ğŸ’¬' : s.channel === 'group' ? 'ğŸ‘¥' : 'ğŸ”Œ';
    const sourceIcon = s.source === 'Fox' ? 'ğŸ¦Š' : 'ğŸ¾';
    const sourceBg = s.source === 'Fox' ? 'bg-orange-500/20 text-orange-300' : 'bg-blue-500/20 text-blue-300';
    return `<div class="card fade-in">
      <div class="flex items-center justify-between mb-2">
        <div class="flex items-center gap-2">
          <span>${kindIcon}</span>
          <span class="text-sm font-medium truncate max-w-[300px]">${escapeHtml(s.session_id||s.key||'')}</span>
          <span class="text-[10px] px-1.5 py-0.5 rounded ${sourceBg}">${sourceIcon} ${s.source||'Cara'}</span>
          <div class="w-2 h-2 rounded-full ${statusDot}"></div>
          <span class="text-xs ${statusColor} capitalize">${s.status||'active'}</span>
        </div>
        <span class="text-xs text-gray-500">${s.age||timeAgo(s.created_at)}</span>
      </div>
      <div class="flex items-center justify-between text-xs text-gray-400 mb-1">
        <span>ğŸ¤– ${escapeHtml(s.model)}</span>
        <span>${s.tokens||''} ${pct>0?`(${pct}%)`:''}</span>
      </div>
      <div class="w-full bg-gray-700 rounded-full h-1 mb-2"><div class="${barColor} rounded-full h-1" style="width:${pct}%"></div></div>
      ${!compact ? `<div class="flex items-center gap-4 text-xs text-gray-500">
        ${s.channel ? `<span>ğŸ“¡ ${s.channel}</span>` : ''}
        ${s.cost ? `<span>ğŸ’° $${parseFloat(s.cost).toFixed(4)}</span>` : ''}
        ${s.messages ? `<span>ğŸ’¬ ${s.messages} msgs</span>` : ''}
      </div>` : ''}
    </div>`;
  }
  // Fallback: raw text
  const raw = s.raw_json;
  if (typeof raw === 'string' && raw.length > 10) {
    return `<div class="card fade-in"><pre class="text-xs text-gray-300 whitespace-pre-wrap font-mono overflow-x-auto ${compact?'max-h-40':''}">${escapeHtml(raw)}</pre><div class="text-xs text-gray-600 mt-2">Captured ${timeAgo(s.created_at)}</div></div>`;
  }
  return `<div class="card fade-in"><pre class="text-xs text-gray-400">${escapeHtml(JSON.stringify(s,null,2))}</pre></div>`;
}

function setSessionFilter(f) {
  sessionFilter = f;
  ['all','active','idle','completed'].forEach(x => {
    const btn = document.getElementById('sf-'+x);
    if (f===x) { btn.className='px-3 py-1 rounded-lg text-xs border bg-blue-600/20 text-blue-400 border-blue-500/30'; }
    else { btn.className='px-3 py-1 rounded-lg text-xs border bg-gray-800 text-gray-400 border-gray-700'; }
  });
  renderSessionsFull();
}

// â”€â”€â”€ Kanban â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COLUMNS = [
  { id:'ideas', label:'Ideas', emoji:'ğŸ’¡' }, { id:'queued', label:'Queued', emoji:'ğŸ“' },
  { id:'in-progress', label:'In Progress', emoji:'ğŸ”¨' }, { id:'done', label:'Done', emoji:'âœ…' },
];
const PROJECT_COLORS = {
  'Fleet':'bg-purple-500/20 text-purple-300 border-purple-500/30',
  'Infrastructure':'bg-blue-500/20 text-blue-300 border-blue-500/30',
  'TEAS Study Guide':'bg-green-500/20 text-green-300 border-green-500/30',
  'Other Projects':'bg-orange-500/20 text-orange-300 border-orange-500/30',
};
let kanbanFilter = 'all';

function renderKanban() {
  const board = document.getElementById('kanban-board');
  const tasks = cachedData.tasks;
  const filtered = kanbanFilter==='all' ? tasks : tasks.filter(t=>t.project===kanbanFilter);
  const projects = [...new Set(tasks.map(t=>t.project).filter(Boolean))];
  document.getElementById('kanban-filters').innerHTML = `
    <button onclick="setKanbanFilter('all')" class="px-3 py-1 rounded-lg text-xs border transition-colors ${kanbanFilter==='all'?'bg-blue-600/20 text-blue-400 border-blue-500/30':'bg-gray-800 text-gray-400 border-gray-700'}">All</button>
    ${projects.map(p=>`<button onclick="setKanbanFilter('${p}')" class="px-3 py-1 rounded-lg text-xs border transition-colors ${kanbanFilter===p?(PROJECT_COLORS[p]||'bg-gray-600/20 text-gray-300 border-gray-500/30'):'bg-gray-800 text-gray-400 border-gray-700'}">${p}</button>`).join('')}`;
  board.innerHTML = COLUMNS.map(col => {
    const colTasks = filtered.filter(t=>t.col===col.id);
    return `<div class="bg-gray-900/50 border border-gray-800 rounded-xl p-3">
      <h3 class="text-sm font-medium mb-3 flex items-center gap-2"><span>${col.emoji}</span> ${col.label} <span class="text-gray-600 text-xs">(${colTasks.length})</span></h3>
      <div class="kanban-col drop-zone space-y-2" data-column="${col.id}" ondragover="event.preventDefault();this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')" ondrop="handleDrop(event,'${col.id}')">
        ${colTasks.map(t=>`<div class="task-card" draggable="true" data-task-id="${t.id}" ondragstart="event.dataTransfer.setData('text/plain','${t.id}')">
          <h4 class="text-sm font-medium mb-1">${escapeHtml(t.title)}</h4>
          ${t.description?`<p class="text-xs text-gray-500 mb-2 line-clamp-2">${escapeHtml(t.description)}</p>`:''}
          <div class="flex items-center gap-2 flex-wrap">
            ${t.project?`<span class="badge ${PROJECT_COLORS[t.project]||'bg-gray-600/20 text-gray-300 border-gray-500/30'}">${escapeHtml(t.project)}</span>`:''}
            ${t.time_minutes>0?`<span class="text-[10px] text-gray-500">â± ${formatTime(t.time_minutes)}</span>`:''}
            ${t.cost_estimate>0?`<span class="text-[10px] text-gray-500">ğŸ’° $${parseFloat(t.cost_estimate).toFixed(2)}</span>`:''}
          </div></div>`).join('')}
      </div></div>`;
  }).join('');
}
function setKanbanFilter(f) { kanbanFilter=f; renderKanban(); }
function handleDrop(event,column) {
  event.preventDefault(); event.currentTarget.classList.remove('drag-over');
  const taskId = event.dataTransfer.getData('text/plain');
  const task = cachedData.tasks.find(t=>t.id===taskId);
  if (task) { task.col=column; renderKanban(); renderQuickStats(); }
}

// â”€â”€â”€ Calendar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCalendar() {
  const el = document.getElementById('calendar-timeline');
  const events = cachedData.calendar;
  const dateEl = document.getElementById('calendar-date');
  if (!events.length) { el.innerHTML = '<div class="card text-center py-8"><p class="text-2xl mb-2">ğŸ“</p><p class="text-gray-500">No events scheduled</p></div>'; return; }

  dateEl.textContent = events[0]?.event_date || new Date().toLocaleDateString();

  // Group by hour
  const hourGroups = {};
  for (const e of events) {
    const h = e.event_hour ?? 0;
    if (!hourGroups[h]) hourGroups[h] = [];
    hourGroups[h].push(e);
  }
  const hours = Object.keys(hourGroups).map(Number).sort((a,b)=>a-b);
  const formatHour = h => h===0?'12 AM':h<12?`${h} AM`:h===12?'12 PM':`${h-12} PM`;
  const sourceColor = src => src==='Fox'?'border-orange-500/50 bg-orange-500/5':'border-blue-500/50 bg-blue-500/5';
  const sourceIcon = src => src==='Fox'?'ğŸ¦Š':'ğŸ¾';

  el.innerHTML = hours.map(hour => `
    <div class="flex gap-4 mb-4">
      <div class="w-16 shrink-0 text-right"><span class="text-xs font-mono text-gray-500">${formatHour(hour)}</span></div>
      <div class="relative flex flex-col items-center"><div class="timeline-dot bg-blue-500"></div><div class="timeline-line flex-1"></div></div>
      <div class="flex-1 space-y-2 pb-2">
        ${hourGroups[hour].map(e => `
          <div class="border rounded-lg p-3 ${sourceColor(e.source)}">
            <div class="flex items-center gap-2 mb-1">
              <span class="text-sm">${sourceIcon(e.source)}</span>
              <span class="text-sm font-medium">${escapeHtml(e.title)}</span>
              ${e.event_time?`<span class="text-[10px] text-gray-500 font-mono">${escapeHtml(e.event_time)}</span>`:''}
              <span class="text-[10px] px-1.5 py-0.5 rounded ${e.source==='Fox'?'bg-orange-500/20 text-orange-300':'bg-blue-500/20 text-blue-300'}">${e.source||'Cara'}</span>
              ${e.event_type?`<span class="text-[10px] px-1.5 py-0.5 rounded bg-gray-700 text-gray-400">${escapeHtml(e.event_type)}</span>`:''}
            </div>
            ${e.details?`<p class="text-xs text-gray-400 ml-6">${escapeHtml(e.details)}</p>`:''}
          </div>`).join('')}
      </div>
    </div>`).join('');
}

// â”€â”€â”€ Agent Errors & Service Health â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderErrors() {
  const el = document.getElementById('error-log');
  const badge = document.getElementById('error-summary-badge');
  const errors = cachedData.errors;
  if (!errors.length) {
    el.innerHTML = '<div class="text-center py-4"><div class="text-3xl mb-2">âœ…</div><p class="text-sm text-gray-400">No errors today</p></div>';
    badge.className = 'text-xs text-green-400'; badge.textContent = 'âœ“ All clear';
    return;
  }
  badge.className = 'text-xs text-red-400 animate-pulse';
  badge.textContent = `${errors.length} error${errors.length!==1?'s':''}`;
  el.innerHTML = errors.map(e => {
    const sevClass = e.severity==='critical'?'severity-critical':e.severity==='error'?'severity-error':e.severity==='warning'?'severity-warning':'severity-info';
    return `<div class="bg-gray-800/50 rounded-lg px-3 py-2 text-xs">
      <div class="flex items-center justify-between mb-1">
        <div class="flex items-center gap-2">
          <span class="${sevClass} font-medium uppercase">${e.severity||'error'}</span>
          <span class="text-gray-500 font-mono">${escapeHtml(e.source||'')}</span>
        </div>
        <div class="flex items-center gap-2">
          ${e.count>1?`<span class="bg-red-900/50 text-red-300 px-1.5 py-0.5 rounded text-[10px]">Ã—${e.count}</span>`:''}
          <span class="text-gray-500">${timeAgo(e.created_at)}</span>
        </div>
      </div>
      <p class="text-gray-300 break-all">${escapeHtml(e.message)}</p>
    </div>`;
  }).join('');
}

function renderServices() {
  const el = document.getElementById('service-health');
  const services = cachedData.services;
  if (!services.length) { el.innerHTML = '<p class="text-xs text-gray-600">No service data</p>'; return; }
  el.innerHTML = services.map(s => `
    <div class="flex items-center justify-between bg-gray-800/50 rounded-lg px-3 py-2">
      <div class="flex items-center gap-2">
        <div class="w-2.5 h-2.5 rounded-full flex-shrink-0 ${s.healthy?'bg-green-400':'bg-red-400 animate-pulse'}"></div>
        <span class="text-sm">${escapeHtml(s.name)}</span>
      </div>
      <div class="flex items-center gap-3">
        <span class="text-xs font-mono ${s.healthy?'text-green-400':'text-red-400'}">${s.http_code||'â€”'}</span>
        <span class="text-xs text-gray-500">${timeAgo(s.last_check)}</span>
      </div>
    </div>`).join('');
}

// â”€â”€â”€ Activity (rich) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CAT_ICONS = { file:'ğŸ“', exec:'âš¡', browser:'ğŸŒ', message:'ğŸ’¬', cron:'â°', search:'ğŸ”', deployment:'ğŸš€', task:'ğŸ“‹', error:'ğŸ”´', sync:'ğŸ”„', gateway:'ğŸŒ', other:'ğŸ“Œ' };
const CAT_COLORS = { file:'bg-blue-500/20 text-blue-300', exec:'bg-yellow-500/20 text-yellow-300', browser:'bg-green-500/20 text-green-300', message:'bg-purple-500/20 text-purple-300', cron:'bg-orange-500/20 text-orange-300', deployment:'bg-cyan-500/20 text-cyan-300', error:'bg-red-500/20 text-red-300', task:'bg-indigo-500/20 text-indigo-300', sync:'bg-gray-500/20 text-gray-300', gateway:'bg-teal-500/20 text-teal-300', other:'bg-gray-500/20 text-gray-300' };

function inferCategory(type, msg) {
  if (!msg) return type || 'other';
  const m = msg.toLowerCase();
  if (m.includes('deploy')) return 'deployment';
  if (m.includes('cron')||m.includes('schedule')) return 'cron';
  if (m.includes('error')||m.includes('fail')) return 'error';
  if (m.includes('file')||m.includes('write')||m.includes('read')) return 'file';
  if (m.includes('exec')||m.includes('command')) return 'exec';
  if (m.includes('browser')) return 'browser';
  if (m.includes('message')||m.includes('telegram')) return 'message';
  return type || 'other';
}

function renderActivity() {
  const el = document.getElementById('activity-feed');
  const items = cachedData.activity.map(a => ({ ...a, category: a.category || inferCategory(a.event_type, a.summary) }));
  if (!items.length) { el.innerHTML = '<p class="text-gray-500 text-sm">No activity yet</p>'; return; }
  document.getElementById('activity-count').textContent = `(${items.length} total)`;

  // Filters
  const cats = [...new Set(items.map(a=>a.category))];
  document.getElementById('activity-filters').innerHTML = `
    <button onclick="setActivityFilter('all')" class="px-3 py-1 rounded-lg text-xs border ${activityFilter==='all'?'bg-blue-600/20 text-blue-400 border-blue-500/30':'bg-gray-800 text-gray-400 border-gray-700'}">All</button>
    ${cats.map(c=>`<button onclick="setActivityFilter('${c}')" class="px-3 py-1 rounded-lg text-xs border ${activityFilter===c?(CAT_COLORS[c]||'bg-gray-600/20 text-gray-300')+' border-gray-700':'bg-gray-800 text-gray-400 border-gray-700'}">${CAT_ICONS[c]||'ğŸ“Œ'} ${c}</button>`).join('')}`;

  let displayed = activityFilter==='all' ? items : items.filter(a=>a.category===activityFilter);
  if (activitySort==='category') displayed = [...displayed].sort((a,b)=>(a.category||'').localeCompare(b.category||''));

  el.innerHTML = displayed.slice(0,100).map(a => `
    <div class="card fade-in flex items-start gap-3 !p-3">
      <span class="text-lg mt-0.5">${CAT_ICONS[a.category]||'ğŸ“Œ'}</span>
      <div class="flex-1 min-w-0">
        <div class="flex items-center gap-2 mb-0.5">
          <span class="text-sm font-medium truncate">${escapeHtml((a.summary||'').slice(0,120))}</span>
          <span class="text-[10px] px-1.5 py-0.5 rounded ${CAT_COLORS[a.category]||'bg-gray-500/20 text-gray-300'}">${a.category}</span>
        </div>
        ${a.details_text?`<p class="text-xs text-gray-500 truncate">${escapeHtml(a.details_text)}</p>`:''}
        <div class="flex items-center gap-3 text-xs text-gray-600 mt-1">
          <span>${timeAgo(a.created_at)}</span>
          ${a.source?`<span>Â· ${a.source}</span>`:''}
          ${a.cost?`<span>Â· ğŸ’° $${parseFloat(a.cost).toFixed(4)}</span>`:''}
          ${a.duration_ms?`<span>Â· â± ${(a.duration_ms/1000).toFixed(1)}s</span>`:''}
        </div>
      </div>
    </div>`).join('');
}

function setActivityFilter(f) { activityFilter=f; renderActivity(); }
function setActivitySort(s) {
  activitySort=s;
  document.getElementById('as-time').className = `text-xs px-2 py-1 rounded ${s==='time'?'bg-blue-600/20 text-blue-400':'text-gray-500 hover:text-gray-300'}`;
  document.getElementById('as-category').className = `text-xs px-2 py-1 rounded ${s==='category'?'bg-blue-600/20 text-blue-400':'text-gray-500 hover:text-gray-300'}`;
  renderActivity();
}

// â”€â”€â”€ Search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doSearch() {
  const q = document.getElementById('search-input').value.toLowerCase().trim();
  const el = document.getElementById('search-results');
  if (!q) { el.innerHTML = ''; return; }

  const results = [];
  const typeIcons = { session:'ğŸ”Œ', task:'ğŸ“‹', activity:'âš¡' };

  // Search sessions
  for (const s of cachedData.sessions) {
    const text = JSON.stringify(s).toLowerCase();
    if (text.includes(q)) results.push({ type:'session', title: s.session_id||s.key||'Session', snippet: `Model: ${s.model||'unknown'} Â· ${s.channel||''}`, data: s });
  }
  // Search tasks
  for (const t of cachedData.tasks) {
    if ((t.title||'').toLowerCase().includes(q) || (t.description||'').toLowerCase().includes(q))
      results.push({ type:'task', title: t.title, snippet: `${t.col} Â· ${t.project||''}`, data: t });
  }
  // Search activity
  for (const a of cachedData.activity) {
    if ((a.summary||'').toLowerCase().includes(q))
      results.push({ type:'activity', title: a.summary, snippet: `${a.event_type} Â· ${timeAgo(a.created_at)}`, data: a });
  }

  const filtered = searchFilter==='all' ? results : results.filter(r=>r.type===searchFilter);

  if (!filtered.length) { el.innerHTML = `<p class="text-gray-500 text-sm text-center mt-8">No results for "${escapeHtml(q)}"</p>`; return; }
  el.innerHTML = filtered.map(r => `
    <div class="card fade-in flex items-start gap-3 !p-3 mb-2">
      <span class="text-lg">${typeIcons[r.type]||'ğŸ“„'}</span>
      <div><p class="text-sm font-medium">${escapeHtml(r.title)}</p>
        ${r.snippet?`<p class="text-xs text-gray-500 mt-0.5">${escapeHtml(r.snippet)}</p>`:''}
        <span class="text-[10px] text-gray-600 mt-1 inline-block bg-gray-800 px-1.5 py-0.5 rounded">${r.type}</span>
      </div>
    </div>`).join('');
}

function setSearchFilter(f) {
  searchFilter = f;
  ['all','session','task','activity'].forEach(x => {
    const btn = document.getElementById('stf-'+x);
    if (f===x) btn.className='px-3 py-1 rounded-lg text-xs border bg-blue-600/20 text-blue-400 border-blue-500/30';
    else btn.className='px-3 py-1 rounded-lg text-xs border bg-gray-800 text-gray-400 border-gray-700';
  });
  doSearch();
}

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escapeHtml(s) { if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function timeAgo(iso) {
  if (!iso) return 'â€”';
  const diff = Date.now()-new Date(iso).getTime();
  const mins = Math.floor(diff/60000);
  if (mins<1) return 'just now'; if (mins<60) return `${mins}m ago`;
  const hrs = Math.floor(mins/60);
  if (hrs<24) return `${hrs}h ${mins%60}m ago`;
  return `${Math.floor(hrs/24)}d ago`;
}
function formatUptime(seconds) {
  if (!seconds) return 'â€”';
  const d=Math.floor(seconds/86400), h=Math.floor((seconds%86400)/3600), m=Math.floor((seconds%3600)/60);
  if (d>0) return `${d}d ${h}h`; if (h>0) return `${h}h ${m}m`; return `${m}m`;
}
function formatTime(minutes) {
  if (!minutes) return '0m';
  const h=Math.floor(minutes/60), m=minutes%60;
  if (h===0) return `${m}m`; if (m===0) return `${h}h`; return `${h}h ${m}m`;
}

// â”€â”€â”€ Demo Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDemoData() {
  const now = new Date();
  cachedData = {
    system: { cpu_usage:23.5, mem_total_gb:24, mem_used_gb:14.2, mem_free_gb:9.8, disk_total_gb:460, disk_used_gb:187, disk_free_gb:273, load_avg:'[1.2, 1.5, 1.8]', uptime_seconds:432000 },
    gateway: { status:'running', version:'0.12.0', pid:12345, uptime:'5d 2h', created_at:now.toISOString() },
    sessions: [
      { session_id:'agent:main:telegram:group', key:'agent:main:telegram:group', model:'claude-opus-4', tokens:'142k/200k', token_pct:71, status:'active', channel:'telegram', source:'Cara', age:'45m', cost:'1.2340', messages:23, created_at:now.toISOString() },
      { session_id:'agent:main:subagent:abc', key:'agent:main:subagent:abc', model:'claude-sonnet-4', tokens:'12k/200k', token_pct:6, status:'active', channel:'subagent', source:'Cara', age:'2m', cost:'0.0450', messages:5, created_at:now.toISOString() },
      { session_id:'agent:main:telegram:dm', key:'agent:main:telegram:dm', model:'claude-opus-4', tokens:'89k/200k', token_pct:44, status:'idle', channel:'telegram', source:'Cara', age:'1h 20m', cost:'0.8900', messages:15, created_at:new Date(now-3600000).toISOString() },
      { session_id:'agent:fox:telegram:group', key:'agent:fox:telegram:group', model:'claude-sonnet-4', tokens:'5k/200k', token_pct:2, status:'active', channel:'telegram', source:'Fox', age:'10m', cost:'0.0120', messages:3, created_at:now.toISOString() },
      { session_id:'agent:main:web:dashboard', key:'agent:main:web:dashboard', model:'claude-sonnet-4', tokens:'180k/200k', token_pct:90, status:'completed', channel:'web', source:'Cara', age:'3h', cost:'2.1500', messages:45, created_at:new Date(now-10800000).toISOString() },
    ],
    tasks: [
      { id:'1', title:'Dashboard v2 Expansion', description:'Add calendar, errors, search, rich sessions', col:'in-progress', project:'Infrastructure', time_minutes:120, cost_estimate:5 },
      { id:'2', title:'Fleet health monitoring', col:'queued', project:'Fleet', time_minutes:60, cost_estimate:2 },
      { id:'3', title:'TEAS Chapter 4', col:'done', project:'TEAS Study Guide', time_minutes:90, cost_estimate:3 },
      { id:'4', title:'Neon DB setup', col:'ideas', project:'Infrastructure', time_minutes:30, cost_estimate:0 },
      { id:'5', title:'Social media automation', description:'X/Twitter browser-based posting', col:'in-progress', project:'Other Projects', time_minutes:45, cost_estimate:1.5 },
      { id:'6', title:'Fox agent deployment', col:'queued', project:'Fleet', time_minutes:90, cost_estimate:2.5 },
    ],
    activity: [
      { event_type:'sync', summary:'Data sync completed successfully', source:'sync.js', category:'sync', created_at:now.toISOString(), duration_ms:1200 },
      { event_type:'deployment', summary:'Dashboard v2 deployed to GitHub Pages', source:'git', category:'deployment', created_at:new Date(now-1800000).toISOString(), cost:'0.05' },
      { event_type:'task', summary:'TEAS Chapter 4 review completed', source:'kanban', category:'task', created_at:new Date(now-3600000).toISOString(), duration_ms:5400000 },
      { event_type:'error', summary:'Fox SSH connection timeout', source:'sync.js', category:'error', created_at:new Date(now-5400000).toISOString() },
      { event_type:'cron', summary:'Heartbeat check executed', source:'cron', category:'cron', created_at:new Date(now-7200000).toISOString(), duration_ms:800 },
      { event_type:'gateway', summary:'Gateway restarted after update', source:'cron', category:'gateway', created_at:new Date(now-10800000).toISOString() },
      { event_type:'message', summary:'Telegram group message processed', source:'telegram', category:'message', created_at:new Date(now-14400000).toISOString(), cost:'0.0234' },
      { event_type:'exec', summary:'Browser automation: X/Twitter post', source:'browser', category:'exec', created_at:new Date(now-18000000).toISOString(), duration_ms:12000 },
      { event_type:'file', summary:'Memory file updated: 2026-02-12.md', source:'agent', category:'file', created_at:new Date(now-21600000).toISOString() },
    ],
    fleet: [
      { node_name:'cara', role:'primary', status:'online', updated_at:now.toISOString() },
      { node_name:'fox', role:'secondary', status:'offline', updated_at:new Date(now-7200000).toISOString() },
    ],
    calendar: [
      { title:'Heartbeat check', event_hour:0, event_time:'00:00', source:'Cara', event_type:'cron', details:'Gateway health + fleet status', event_date:now.toLocaleDateString() },
      { title:'Data sync', event_hour:0, event_time:'00:02', source:'Cara', event_type:'cron', details:'Push metrics to Neon DB' },
      { title:'Morning social media check', event_hour:8, event_time:'08:00', source:'Cara', event_type:'scheduled', details:'Check X/Twitter, Instagram engagement' },
      { title:'TEAS study session', event_hour:10, event_time:'10:00', source:'Cara', event_type:'task', details:'Chapter 5: Science review' },
      { title:'Nurse.org deploy check', event_hour:12, event_time:'12:00', source:'Cara', event_type:'cron', details:'Verify staging deployment health' },
      { title:'Fox fleet sync', event_hour:14, event_time:'14:00', source:'Fox', event_type:'cron', details:'Cross-node data synchronization' },
      { title:'GA4 traffic report', event_hour:16, event_time:'16:00', source:'Cara', event_type:'scheduled', details:'Daily traffic summary for TMR + Nurse.org' },
      { title:'Dashboard metrics push', event_hour:18, event_time:'18:00', source:'Cara', event_type:'cron', details:'End-of-day metrics snapshot' },
      { title:'Memory consolidation', event_hour:22, event_time:'22:00', source:'Cara', event_type:'scheduled', details:'Daily memory file cleanup and MEMORY.md update' },
    ],
    errors: [
      { message:'SSH connection to fox-mini.local timed out after 15s', severity:'warning', source:'sync.js', count:3, created_at:new Date(now-5400000).toISOString() },
      { message:'Rate limit exceeded on X/Twitter API (429)', severity:'error', source:'browser', count:1, created_at:new Date(now-18000000).toISOString() },
      { message:'Neon connection pool exhausted â€” retrying in 5s', severity:'warning', source:'sync.js', count:2, created_at:new Date(now-28800000).toISOString() },
    ],
    services: [
      { name:'TEAS Study Site', healthy:true, http_code:'200', last_check:now.toISOString() },
      { name:'AI Tutor API', healthy:true, http_code:'200', last_check:now.toISOString() },
      { name:'Nurse.org', healthy:true, http_code:'200', last_check:now.toISOString() },
      { name:'Cara HQ Dashboard', healthy:true, http_code:'200', last_check:now.toISOString() },
      { name:'Fox Mini (SSH)', healthy:false, http_code:'timeout', last_check:new Date(now-5400000).toISOString() },
      { name:'Neon Postgres', healthy:true, http_code:'200', last_check:now.toISOString() },
    ],
  };
  renderAll();
  document.getElementById('sync-indicator').textContent = 'ğŸ­ Demo';
}

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initDashboard() {
  switchTab('overview');
  updateClock();
  setInterval(updateClock, 1000);
  loadAllData();
  setInterval(loadAllData, REFRESH_INTERVAL);
}
</script>
</body>
</html>
